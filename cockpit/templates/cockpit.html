<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HumanGR - Pipeline Cockpit</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cockpit.css') }}?v=20260201-1">
    <style>
        /* ===== VIEW TOGGLE ===== */
        .view-toggle {
            display: flex;
            gap: 4px;
            background: var(--bg-muted);
            padding: 3px;
            border-radius: 6px;
            margin-right: 12px;
        }
        .view-toggle-btn {
            padding: 4px 10px;
            font-size: 10px;
            font-weight: 500;
            border: none;
            background: transparent;
            color: var(--text-muted);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .view-toggle-btn.active {
            background: var(--accent);
            color: white;
        }
        .view-toggle-btn:hover:not(.active) {
            color: var(--text-primary);
        }

        /* ===== GRID VIEW (Layer Columns) ===== */
        .flowchart.grid-view {
            display: grid !important;
            grid-template-columns: repeat(7, 1fr);
            gap: 12px;
            padding: 16px;
            min-height: auto;
            overflow-x: auto;
        }
        .layer-column {
            display: none;
            flex-direction: column;
            gap: 10px;
            padding: 8px;
            background: rgba(255,255,255,0.02);
            border-radius: 10px;
            border: 1px solid var(--border-subtle);
        }
        .flowchart.grid-view .layer-column {
            display: flex;
        }
        .flowchart.grid-view .flow-node.absolute-node,
        .flowchart.grid-view .phase-header,
        .flowchart.grid-view .flow-legend.absolute-legend {
            display: none !important;
        }
        .layer-header {
            text-align: center;
            font-size: 10px;
            font-weight: 600;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            padding: 6px 4px;
            border-radius: 5px;
            margin-bottom: 6px;
        }
        .layer-header.l0 { background: rgba(239, 68, 68, 0.15); color: var(--l0); border: 1px solid var(--l0); }
        .layer-header.l1 { background: rgba(245, 158, 11, 0.15); color: var(--l1); border: 1px solid var(--l1); }
        .layer-header.l2 { background: rgba(234, 179, 8, 0.15); color: var(--l2); border: 1px solid var(--l2); }
        .layer-header.l3 { background: rgba(34, 197, 94, 0.15); color: var(--l3); border: 1px solid var(--l3); }
        .layer-header.l4 { background: rgba(6, 182, 212, 0.15); color: var(--l4); border: 1px solid var(--l4); }
        .layer-header.l5 { background: rgba(59, 130, 246, 0.15); color: var(--l5); border: 1px solid var(--l5); }
        .layer-header.l6 { background: rgba(139, 92, 246, 0.15); color: var(--l6); border: 1px solid var(--l6); }

        .layer-column .flow-node {
            position: relative !important;
            transform: none !important;
            left: auto !important;
            top: auto !important;
        }
        .layer-column .flow-node-icon {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            margin: 0 auto;
        }
        .layer-column .flow-node-icon svg {
            width: 22px;
            height: 22px;
        }
        .layer-column .flow-node-label {
            font-size: 8px;
            margin-top: 4px;
        }
        .layer-column.l5-column {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            align-content: start;
        }
        .flowchart.grid-view .layer-column.l5-column {
            display: grid;
        }
        .layer-column.l5-column .layer-header { grid-column: 1 / -1; }
        .layer-column.l5-column .flow-node { justify-self: center; }
        .l5-sublabel {
            grid-column: 1 / -1;
            font-size: 7px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.4px;
            padding: 3px 0;
            border-top: 1px solid var(--border-subtle);
            margin-top: 2px;
            text-align: center;
        }
        .flowchart.grid-view .flow-connections { display: none; }
        .flow-legend.grid-legend {
            display: none;
            grid-column: 1 / -1;
            position: static;
            margin-top: 12px;
        }
        .flowchart.grid-view .flow-legend.grid-legend { display: block; }

        /* ===== FLOW VIEW (Dynamic Absolute) ===== */
        .flowchart.flow-view {
            position: relative;
            min-width: 1800px;
            min-height: 550px;
            padding: 40px;
        }
        .flowchart.flow-view .layer-column { display: none !important; }
        .flowchart.flow-view .flow-legend.grid-legend { display: none !important; }
        .flowchart.flow-view .flow-node.absolute-node { display: flex; }
        .flowchart.flow-view .phase-header { display: block; }
        .flowchart.flow-view .flow-legend.absolute-legend { display: block; }
    </style>
</head>
<body>
    <div class="cockpit">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <div class="logo-icon">HL</div>
                <span class="logo-text">HumanGR Cockpit</span>
                <span class="connection-status" id="connection-status" title="WebSocket connection status"></span>
            </div>
            <div class="header-stats">
                <div class="header-stat">
                    <span class="status-dot"></span>
                    <span class="header-stat-label">Status</span>
                    <span class="header-stat-value" id="header-status">Connecting...</span>
                </div>
                <div class="header-stat">
                    <span class="header-stat-label">Sprint</span>
                    <span class="header-stat-value" style="color: var(--accent-light);" id="header-sprint">--</span>
                </div>
                <div class="header-stat">
                    <span class="header-stat-label">Elapsed</span>
                    <span class="header-stat-value" id="elapsed">00:00:00</span>
                </div>
                <div class="header-stat">
                    <span class="header-stat-label">Phase</span>
                    <span class="header-stat-value" id="header-phase">--</span>
                </div>
            </div>
        </header>

        <!-- Pipeline Control Panel -->
        <div class="pipeline-control-panel" id="pipeline-control">
            <div class="control-section">
                <div class="control-label">Sprint Range</div>
                <div class="sprint-selectors">
                    <select id="start-sprint" class="sprint-select"><option value="S00">S00</option></select>
                    <span class="sprint-arrow">-></span>
                    <select id="end-sprint" class="sprint-select"><option value="S25">S25</option></select>
                </div>
            </div>
            <div class="control-section">
                <div class="control-label">Pipeline Control</div>
                <div class="control-buttons">
                    <button class="control-btn start-btn" id="btn-start" onclick="pipelineStart()">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><polygon points="5,3 19,12 5,21"/></svg>
                        Start
                    </button>
                    <button class="control-btn pause-btn" id="btn-pause" onclick="pipelinePause()" disabled>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>
                        Pause
                    </button>
                    <button class="control-btn abort-btn" id="btn-abort" onclick="pipelineAbort()" disabled>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><rect x="4" y="4" width="16" height="16" rx="2"/></svg>
                        Abort
                    </button>
                    <button class="control-btn resume-checkpoint-btn" id="btn-lg-resume" onclick="pipelineLgResume()" title="Resume from LangGraph checkpoint">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"/></svg>
                        Resume Checkpoint
                    </button>
                </div>
            </div>
            <div class="control-section">
                <div class="control-label">Status</div>
                <div class="pipeline-status" id="pipeline-status">
                    <span class="status-indicator idle" id="pipeline-status-indicator"></span>
                    <span class="status-text" id="pipeline-status-text">Idle</span>
                </div>
            </div>
        </div>

        <!-- Hero Metrics Row -->
        <div class="hero-row">
            <div class="hero-metrics">
                <div class="hero-metric accent">
                    <div class="hero-metric-value" id="metric-sprint">--</div>
                    <div class="hero-metric-label">Sprint</div>
                </div>
                <div class="hero-metric">
                    <div class="hero-metric-value" id="metric-progress">--%</div>
                    <div class="hero-metric-label">Progress</div>
                </div>
                <div class="hero-metric success">
                    <div class="hero-metric-value" id="metric-agents">--</div>
                    <div class="hero-metric-label">Agents</div>
                </div>
                <div class="hero-metric">
                    <div class="hero-metric-value" id="metric-tokens">--</div>
                    <div class="hero-metric-label">Tokens</div>
                </div>
                <div class="hero-metric">
                    <div class="hero-metric-value" id="metric-tasks">--/--</div>
                    <div class="hero-metric-label">Tasks</div>
                </div>
                <div class="hero-metric warning">
                    <div class="hero-metric-value" id="metric-warnings">--</div>
                    <div class="hero-metric-label">Warnings</div>
                </div>
                <div class="hero-metric">
                    <div class="hero-metric-value" id="metric-stacks">--/--</div>
                    <div class="hero-metric-label">Stacks</div>
                </div>
            </div>
            <div class="completion-compact">
                <svg class="completion-donut" viewBox="0 0 36 36">
                    <circle cx="18" cy="18" r="14" fill="none" stroke="var(--bg-muted)" stroke-width="3" />
                    <circle id="donut-complete" cx="18" cy="18" r="14" fill="none" stroke="var(--success)" stroke-width="3" stroke-dasharray="0 100" stroke-dashoffset="25" transform="rotate(-90 18 18)" />
                    <circle id="donut-active" cx="18" cy="18" r="14" fill="none" stroke="var(--info)" stroke-width="3" stroke-dasharray="0 100" stroke-dashoffset="25" transform="rotate(-90 18 18)" />
                    <text x="18" y="20" text-anchor="middle" font-size="7" font-weight="600" fill="var(--text-primary)" id="donut-pct">--%</text>
                </svg>
                <div class="completion-info">
                    <div class="completion-label">Completion</div>
                    <div class="completion-row"><div class="completion-dot" style="background:var(--success)"></div><span id="pct-done">Done --%</span></div>
                    <div class="completion-row"><div class="completion-dot" style="background:var(--info)"></div><span id="pct-active">Active --%</span></div>
                    <div class="completion-row"><div class="completion-dot" style="background:var(--text-muted)"></div><span id="pct-pending">Pending --%</span></div>
                </div>
            </div>
        </div>

        <!-- Live Execution Flow -->
        <div class="panel flow-panel" id="flow-panel">
            <div class="panel-header">
                <span class="panel-title">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--accent-light)" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v10"/>
                    </svg>
                    Live Execution Flow
                </span>
                <div style="display:flex;align-items:center;gap:8px;">
                    <div class="view-toggle">
                        <button class="view-toggle-btn active" id="btn-flow-view" onclick="setView('flow')">Flow</button>
                        <button class="view-toggle-btn" id="btn-grid-view" onclick="setView('grid')">Grid</button>
                    </div>
                    <span class="panel-badge" id="phase-badge">Phase --/--</span>
                    <button class="fullscreen-btn" onclick="toggleFlowFullscreen()" title="Toggle Fullscreen">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/>
                            <line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="panel-body no-pad">
                <div class="flowchart flow-view" id="flowchart">
                    <!-- SVG for connections -->
                    <svg class="flow-connections" id="flow-svg"></svg>

                    <!-- ===============================================================
                         FLOW VIEW: Phase Headers
                         =============================================================== -->
                    <div class="phase-header" style="left: 5%; top: 3%;">INIT</div>
                    <div class="phase-header" style="left: 18%; top: 3%;">SPEC</div>
                    <div class="phase-header" style="left: 38%; top: 3%;">EXEC</div>
                    <div class="phase-header" style="left: 62%; top: 3%;">GATES</div>
                    <div class="phase-header" style="left: 82%; top: 3%;">SIGNOFF</div>
                    <div class="phase-header" style="left: 95%; top: 3%;">DONE</div>

                    <!-- ===============================================================
                         FLOW VIEW: Absolute Positioned Nodes (Dynamic Layout)
                         =============================================================== -->
                    <!-- INIT Phase -->
                    <div class="flow-node pending absolute-node" id="node-init" data-layer="0" style="left: 5%; top: 30%;" onclick="showNodePopup('init')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke-width="2"/><path d="M12 7v5l3 2" stroke-width="2" stroke-linecap="round"/></svg></div>
                        <div class="flow-node-label">Run Master</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-load" data-layer="0" style="left: 5%; top: 55%;" onclick="showNodePopup('load')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M12 3v12m0 0l-4-4m4 4l4-4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2" stroke-width="2" stroke-linecap="round"/></svg></div>
                        <div class="flow-node-label">Load Ctx</div>
                    </div>

                    <!-- SPEC Phase -->
                    <div class="flow-node pending absolute-node" id="node-specvp" data-layer="2" style="left: 15%; top: 25%;" onclick="showNodePopup('specvp')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1" stroke-width="2"/><rect x="14" y="3" width="7" height="7" rx="1" stroke-width="2"/><rect x="3" y="14" width="7" height="7" rx="1" stroke-width="2"/><rect x="14" y="14" width="7" height="7" rx="1" stroke-width="2"/></svg></div>
                        <div class="flow-node-label">Spec VP</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-spec" data-layer="3" style="left: 22%; top: 40%;" onclick="showNodePopup('spec')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z" stroke-width="2"/><path d="M14 2v6h6M9 13h6M9 17h4" stroke-width="2" stroke-linecap="round"/></svg></div>
                        <div class="flow-node-label">Spec Master</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-inv" data-layer="5" style="left: 15%; top: 60%;" onclick="showNodePopup('inv')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><circle cx="10" cy="10" r="7" stroke-width="2"/><path d="M21 21l-4.35-4.35" stroke-width="2" stroke-linecap="round"/></svg></div>
                        <div class="flow-node-label">Auditor</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-deps" data-layer="5" style="left: 22%; top: 75%;" onclick="showNodePopup('deps')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><circle cx="5" cy="6" r="3" stroke-width="2"/><circle cx="19" cy="6" r="3" stroke-width="2"/><circle cx="12" cy="18" r="3" stroke-width="2"/><path d="M5 9v3a4 4 0 004 4h2M19 9v3a4 4 0 01-4 4h-2" stroke-width="2"/></svg></div>
                        <div class="flow-node-label">Dep Map</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-plan" data-layer="3" style="left: 28%; top: 55%;" onclick="showNodePopup('plan')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-width="2"/></svg></div>
                        <div class="flow-node-label">Sprint Plan</div>
                    </div>

                    <!-- EXEC Phase -->
                    <div class="flow-node pending absolute-node" id="node-execvp" data-layer="2" style="left: 35%; top: 20%;" onclick="showNodePopup('execvp')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2" stroke-width="2"/><rect x="8" y="2" width="8" height="4" rx="1" stroke-width="2"/><path d="M9 12l2 2 4-4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                        <div class="flow-node-label">Exec VP</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-spawn" data-layer="4" style="left: 35%; top: 40%;" onclick="showNodePopup('spawn')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><circle cx="9" cy="7" r="4" stroke-width="2"/><path d="M3 21v-2a4 4 0 014-4h4a4 4 0 014 4v2" stroke-width="2"/><path d="M16 11h6m-3-3v6" stroke-width="2" stroke-linecap="round"/></svg></div>
                        <div class="flow-node-label">Spawn</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-assign" data-layer="4" style="left: 35%; top: 60%;" onclick="showNodePopup('assign')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><circle cx="9" cy="7" r="4" stroke-width="2"/><path d="M3 21v-2a4 4 0 014-4h4a4 4 0 014 4v2" stroke-width="2"/><path d="M16 3l2 2 4-4M16 11l2-2 4 4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                        <div class="flow-node-label">Assign</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-exec1" data-layer="5" style="left: 42%; top: 30%;" onclick="showNodePopup('exec1')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M12 6v12M6 12h12" stroke-width="2.5" stroke-linecap="round"/></svg></div>
                        <div class="flow-node-label">RF-001</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-exec2" data-layer="5" style="left: 42%; top: 50%;" onclick="showNodePopup('exec2')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M12 6v12M6 12h12" stroke-width="2.5" stroke-linecap="round"/></svg></div>
                        <div class="flow-node-label">RF-002</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-exec3" data-layer="5" style="left: 42%; top: 70%;" onclick="showNodePopup('exec3')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M12 6v12M6 12h12" stroke-width="2.5" stroke-linecap="round"/></svg></div>
                        <div class="flow-node-label">RF-003</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-exec4" data-layer="5" style="left: 48%; top: 40%;" onclick="showNodePopup('exec4')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M12 6v12M6 12h12" stroke-width="2.5" stroke-linecap="round"/></svg></div>
                        <div class="flow-node-label">RF-004</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-test" data-layer="3" style="left: 48%; top: 60%;" onclick="showNodePopup('test')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" stroke-width="2" stroke-linejoin="round"/></svg></div>
                        <div class="flow-node-label">Ace Exec</div>
                    </div>

                    <!-- GATES Phase -->
                    <div class="flow-node pending absolute-node" id="node-qa" data-layer="3" style="left: 55%; top: 20%;" onclick="showNodePopup('qa')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z" stroke-width="2"/><circle cx="12" cy="12" r="3" stroke-width="2"/></svg></div>
                        <div class="flow-node-label">QA Master</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-g0" data-layer="5" style="left: 55%; top: 40%;" onclick="showNodePopup('g0')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke-width="2"/></svg></div>
                        <div class="flow-node-label">G0</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-g1" data-layer="5" style="left: 60%; top: 30%;" onclick="showNodePopup('g1')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke-width="2"/></svg></div>
                        <div class="flow-node-label">G1</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-g2" data-layer="5" style="left: 60%; top: 50%;" onclick="showNodePopup('g2')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke-width="2"/></svg></div>
                        <div class="flow-node-label">G2</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-g3" data-layer="5" style="left: 65%; top: 40%;" onclick="showNodePopup('g3')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke-width="2"/></svg></div>
                        <div class="flow-node-label">G3</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-g4" data-layer="5" style="left: 55%; top: 60%;" onclick="showNodePopup('g4')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke-width="2"/></svg></div>
                        <div class="flow-node-label">G4</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-g5" data-layer="5" style="left: 60%; top: 70%;" onclick="showNodePopup('g5')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke-width="2"/></svg></div>
                        <div class="flow-node-label">G5</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-g6" data-layer="5" style="left: 65%; top: 60%;" onclick="showNodePopup('g6')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke-width="2"/></svg></div>
                        <div class="flow-node-label">G6</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-g7" data-layer="5" style="left: 70%; top: 45%;" onclick="showNodePopup('g7')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke-width="2"/></svg></div>
                        <div class="flow-node-label">G7</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-g8" data-layer="5" style="left: 70%; top: 65%;" onclick="showNodePopup('g8')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke-width="2"/></svg></div>
                        <div class="flow-node-label">G8</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-reflex" data-layer="6" style="left: 70%; top: 25%;" onclick="showNodePopup('reflex')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 109-9" stroke-width="2" stroke-linecap="round"/><path d="M3 3v6h6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                        <div class="flow-node-label">Reflexion</div>
                    </div>

                    <!-- SIGNOFF Phase -->
                    <div class="flow-node pending absolute-node" id="node-merge" data-layer="3" style="left: 78%; top: 30%;" onclick="showNodePopup('merge')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><circle cx="6" cy="4" r="2" stroke-width="2"/><circle cx="18" cy="4" r="2" stroke-width="2"/><circle cx="12" cy="20" r="2" stroke-width="2"/><path d="M6 6v4a6 6 0 006 6m6-10v4a6 6 0 01-6 6" stroke-width="2"/></svg></div>
                        <div class="flow-node-label">Merge</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-review" data-layer="5" style="left: 78%; top: 50%;" onclick="showNodePopup('review')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="8" r="5" stroke-width="2"/><path d="M3 21v-2a7 7 0 0114 0v2" stroke-width="2"/></svg></div>
                        <div class="flow-node-label">Reviewer</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-rework" data-layer="5" style="left: 78%; top: 70%;" onclick="showNodePopup('rework')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 109-9" stroke-width="2" stroke-linecap="round"/><path d="M3 3v6h6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                        <div class="flow-node-label">Rework</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-signoff" data-layer="1" style="left: 85%; top: 40%;" onclick="showNodePopup('signoff')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z" stroke-width="2"/><path d="M9 15l2 2 4-4" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                        <div class="flow-node-label">CEO Signoff</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-docs" data-layer="0" style="left: 85%; top: 60%;" onclick="showNodePopup('docs')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M4 4h16v16H4z" stroke-width="2" rx="1"/><path d="M8 8h8M8 12h6M8 16h4" stroke-width="2" stroke-linecap="round"/></svg></div>
                        <div class="flow-node-label">Docs</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-art" data-layer="0" style="left: 85%; top: 80%;" onclick="showNodePopup('art')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z" stroke-width="2"/></svg></div>
                        <div class="flow-node-label">Artifacts</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-metrics" data-layer="0" style="left: 92%; top: 55%;" onclick="showNodePopup('metrics')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M3 3v18h18" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M7 16l4-4 4 4 5-6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                        <div class="flow-node-label">Metrics</div>
                    </div>

                    <!-- DONE Phase -->
                    <div class="flow-node pending absolute-node" id="node-handoff" data-layer="0" style="left: 92%; top: 35%;" onclick="showNodePopup('handoff')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M5 12h14M12 5l7 7-7 7" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                        <div class="flow-node-label">Handoff</div>
                    </div>
                    <div class="flow-node pending absolute-node" id="node-done" data-layer="0" style="left: 92%; top: 75%;" onclick="showNodePopup('done')">
                        <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-10-10" stroke-width="2"/><path d="M22 4L12 14.01l-3-3" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                        <div class="flow-node-label">Done</div>
                    </div>

                    <!-- Flow Legend -->
                    <div class="flow-legend absolute-legend">
                        <div class="flow-legend-title">States</div>
                        <div class="flow-legend-items">
                            <div class="flow-legend-item"><span class="state-dot complete"></span>Complete</div>
                            <div class="flow-legend-item"><span class="state-dot active"></span>Active</div>
                            <div class="flow-legend-item"><span class="state-dot warning"></span>Warning</div>
                            <div class="flow-legend-item"><span class="state-dot error"></span>Error</div>
                        </div>
                        <div class="flow-legend-title" style="margin-top:8px">Hierarchy</div>
                        <div class="flow-legend-items">
                            <div class="flow-legend-item"><span class="layer-dot l0"></span>L0</div>
                            <div class="flow-legend-item"><span class="layer-dot l1"></span>L1</div>
                            <div class="flow-legend-item"><span class="layer-dot l2"></span>L2</div>
                            <div class="flow-legend-item"><span class="layer-dot l3"></span>L3</div>
                            <div class="flow-legend-item"><span class="layer-dot l4"></span>L4</div>
                            <div class="flow-legend-item"><span class="layer-dot l5"></span>L5</div>
                            <div class="flow-legend-item"><span class="layer-dot l6"></span>L6</div>
                        </div>
                    </div>

                    <!-- ===============================================================
                         GRID VIEW: Layer Columns (simplified - same structure as flow)
                         =============================================================== -->
                    <div class="layer-column">
                        <div class="layer-header l0">L0 System</div>
                        <div class="flow-node pending" data-node="init" data-layer="0" onclick="showNodePopup('init')">
                            <div class="flow-node-icon"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" stroke-width="2"/><path d="M12 7v5l3 2" stroke-width="2" stroke-linecap="round"/></svg></div>
                            <div class="flow-node-label">Run Master</div>
                        </div>
                        <div class="flow-node pending" data-node="load" data-layer="0" onclick="showNodePopup('load')">
                            <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M12 3v12m0 0l-4-4m4 4l4-4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M4 17v2a2 2 0 002 2h12a2 2 0 002-2v-2" stroke-width="2" stroke-linecap="round"/></svg></div>
                            <div class="flow-node-label">Load</div>
                        </div>
                        <div class="flow-node pending" data-node="docs" data-layer="0" onclick="showNodePopup('docs')">
                            <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M4 4h16v16H4z" stroke-width="2" rx="1"/><path d="M8 8h8M8 12h6M8 16h4" stroke-width="2" stroke-linecap="round"/></svg></div>
                            <div class="flow-node-label">Docs</div>
                        </div>
                        <div class="flow-node pending" data-node="done" data-layer="0" onclick="showNodePopup('done')">
                            <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 11-10-10" stroke-width="2"/><path d="M22 4L12 14.01l-3-3" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                            <div class="flow-node-label">Done</div>
                        </div>
                    </div>
                    <div class="layer-column">
                        <div class="layer-header l1">L1 Exec</div>
                        <div class="flow-node pending" data-node="signoff" data-layer="1" onclick="showNodePopup('signoff')">
                            <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z" stroke-width="2"/><path d="M9 15l2 2 4-4" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                            <div class="flow-node-label">CEO Signoff</div>
                        </div>
                    </div>
                    <div class="layer-column">
                        <div class="layer-header l2">L2 VPs</div>
                        <div class="flow-node pending" data-node="specvp" data-layer="2" onclick="showNodePopup('specvp')">
                            <div class="flow-node-icon"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7" rx="1" stroke-width="2"/><rect x="14" y="3" width="7" height="7" rx="1" stroke-width="2"/><rect x="3" y="14" width="7" height="7" rx="1" stroke-width="2"/><rect x="14" y="14" width="7" height="7" rx="1" stroke-width="2"/></svg></div>
                            <div class="flow-node-label">Spec VP</div>
                        </div>
                        <div class="flow-node pending" data-node="execvp" data-layer="2" onclick="showNodePopup('execvp')">
                            <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2" stroke-width="2"/><rect x="8" y="2" width="8" height="4" rx="1" stroke-width="2"/><path d="M9 12l2 2 4-4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                            <div class="flow-node-label">Exec VP</div>
                        </div>
                    </div>
                    <div class="layer-column">
                        <div class="layer-header l3">L3 Masters</div>
                        <div class="flow-node pending" data-node="spec" data-layer="3" onclick="showNodePopup('spec')">
                            <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z" stroke-width="2"/><path d="M14 2v6h6M9 13h6M9 17h4" stroke-width="2" stroke-linecap="round"/></svg></div>
                            <div class="flow-node-label">Spec Master</div>
                        </div>
                        <div class="flow-node pending" data-node="qa" data-layer="3" onclick="showNodePopup('qa')">
                            <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z" stroke-width="2"/><circle cx="12" cy="12" r="3" stroke-width="2"/></svg></div>
                            <div class="flow-node-label">QA Master</div>
                        </div>
                    </div>
                    <div class="layer-column">
                        <div class="layer-header l4">L4 Leads</div>
                        <div class="flow-node pending" data-node="spawn" data-layer="4" onclick="showNodePopup('spawn')">
                            <div class="flow-node-icon"><svg viewBox="0 0 24 24"><circle cx="9" cy="7" r="4" stroke-width="2"/><path d="M3 21v-2a4 4 0 014-4h4a4 4 0 014 4v2" stroke-width="2"/><path d="M16 11h6m-3-3v6" stroke-width="2" stroke-linecap="round"/></svg></div>
                            <div class="flow-node-label">Spawn</div>
                        </div>
                        <div class="flow-node pending" data-node="assign" data-layer="4" onclick="showNodePopup('assign')">
                            <div class="flow-node-icon"><svg viewBox="0 0 24 24"><circle cx="9" cy="7" r="4" stroke-width="2"/><path d="M3 21v-2a4 4 0 014-4h4a4 4 0 014 4v2" stroke-width="2"/><path d="M16 3l2 2 4-4M16 11l2-2 4 4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                            <div class="flow-node-label">Assign</div>
                        </div>
                    </div>
                    <div class="layer-column l5-column">
                        <div class="layer-header l5">L5 Workers</div>
                        <div class="flow-node pending" data-node="g0" data-layer="5" onclick="showNodePopup('g0')">
                            <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke-width="2"/></svg></div>
                            <div class="flow-node-label">G0</div>
                        </div>
                        <div class="flow-node pending" data-node="g1" data-layer="5" onclick="showNodePopup('g1')">
                            <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke-width="2"/></svg></div>
                            <div class="flow-node-label">G1</div>
                        </div>
                        <div class="flow-node pending" data-node="g2" data-layer="5" onclick="showNodePopup('g2')">
                            <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" stroke-width="2"/></svg></div>
                            <div class="flow-node-label">G2</div>
                        </div>
                    </div>
                    <div class="layer-column">
                        <div class="layer-header l6">L6 AI</div>
                        <div class="flow-node pending" data-node="reflex" data-layer="6" onclick="showNodePopup('reflex')">
                            <div class="flow-node-icon"><svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 109-9" stroke-width="2" stroke-linecap="round"/><path d="M3 3v6h6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                            <div class="flow-node-label">Reflexion</div>
                        </div>
                    </div>

                    <!-- Grid Legend -->
                    <div class="flow-legend grid-legend">
                        <div class="flow-legend-title">Node States</div>
                        <div class="flow-legend-items">
                            <div class="flow-legend-item"><span class="state-dot complete"></span>Complete</div>
                            <div class="flow-legend-item"><span class="state-dot active"></span>Active</div>
                            <div class="flow-legend-item"><span class="state-dot warning"></span>Warning</div>
                            <div class="flow-legend-item"><span class="state-dot error"></span>Error</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Node Popup Overlay -->
        <div class="node-popup-overlay" id="node-popup-overlay" onclick="closeNodePopup(event)">
            <div class="node-popup" onclick="event.stopPropagation()">
                <div class="node-popup-header">
                    <div class="node-popup-title">
                        <div class="status-indicator active"></div>
                        <span id="popup-title">Node Details</span>
                    </div>
                    <button class="node-popup-close" onclick="closeNodePopup()">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                        </svg>
                    </button>
                </div>
                <div class="node-popup-body" id="popup-body"></div>
            </div>
        </div>

        <!-- Summary Panel -->
        <div class="panel" style="margin-top: 6px;">
            <div class="panel-header">
                <span class="panel-title">Pipeline Summary</span>
                <span class="panel-badge" id="summary-badge">--</span>
            </div>
            <div class="panel-body">
                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;">
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--text-primary);" id="summary-total">--</div>
                        <div style="font-size: 10px; color: var(--text-muted);">Total Nodes</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="summary-complete">--</div>
                        <div style="font-size: 10px; color: var(--text-muted);">Complete</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--accent-light);" id="summary-active">--</div>
                        <div style="font-size: 10px; color: var(--text-muted);">Active</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-size: 24px; font-weight: 700; color: var(--error);" id="summary-errors">--</div>
                        <div style="font-size: 10px; color: var(--text-muted);">Errors</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Pipeline Output Panel -->
    <div class="pipeline-output-panel" id="pipeline-output-panel">
        <div class="pipeline-output-header">
            <div class="pipeline-output-title">
                <span class="status-dot" id="output-status-dot"></span>
                Pipeline Logs
            </div>
            <div class="pipeline-output-actions">
                <button class="pipeline-output-btn" onclick="clearOutput()">Clear</button>
            </div>
        </div>
        <div class="pipeline-output" id="pipeline-output"></div>
    </div>

    <!-- Socket.IO -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <!-- Node data -->
    <script>
        window.nodeData = {
            init: { title: 'Pipeline Initialization', status: 'pending', metrics: {}, logs: [] },
            load: { title: 'Load Sprint Context', status: 'pending', metrics: {}, logs: [] },
            spec: { title: 'Spec Generation', status: 'pending', metrics: {}, logs: [] },
            specvp: { title: 'Spec VP', status: 'pending', metrics: {}, logs: [] },
            execvp: { title: 'Exec VP', status: 'pending', metrics: {}, logs: [] },
            inv: { title: 'Invariant Validation', status: 'pending', metrics: {}, logs: [] },
            deps: { title: 'Dependency Mapping', status: 'pending', metrics: {}, logs: [] },
            plan: { title: 'Plan Creation', status: 'pending', metrics: {}, logs: [] },
            spawn: { title: 'Agent Spawning', status: 'pending', metrics: {}, logs: [] },
            assign: { title: 'Task Assignment', status: 'pending', metrics: {}, logs: [] },
            exec1: { title: 'RF-001 Execution', status: 'pending', metrics: {}, logs: [] },
            exec2: { title: 'RF-002 Execution', status: 'pending', metrics: {}, logs: [] },
            exec3: { title: 'RF-003 Execution', status: 'pending', metrics: {}, logs: [] },
            exec4: { title: 'RF-004 Execution', status: 'pending', metrics: {}, logs: [] },
            test: { title: 'Test Execution', status: 'pending', metrics: {}, logs: [] },
            g0: { title: 'Gate G0: Grounding', status: 'pending', metrics: {}, logs: [] },
            g1: { title: 'Gate G1: Models', status: 'pending', metrics: {}, logs: [] },
            g2: { title: 'Gate G2: Logic', status: 'pending', metrics: {}, logs: [] },
            g3: { title: 'Gate G3: Tests', status: 'pending', metrics: {}, logs: [] },
            g4: { title: 'Gate G4: Integration', status: 'pending', metrics: {}, logs: [] },
            g5: { title: 'Gate G5: Docs', status: 'pending', metrics: {}, logs: [] },
            g6: { title: 'Gate G6: Security', status: 'pending', metrics: {}, logs: [] },
            g7: { title: 'Gate G7: Performance', status: 'pending', metrics: {}, logs: [] },
            g8: { title: 'Gate G8: ORR', status: 'pending', metrics: {}, logs: [] },
            reflex: { title: 'Reflexion Engine', status: 'pending', metrics: {}, logs: [] },
            merge: { title: 'Merge & Consolidate', status: 'pending', metrics: {}, logs: [] },
            qa: { title: 'QA Synthesis', status: 'pending', metrics: {}, logs: [] },
            review: { title: 'Human Review', status: 'pending', metrics: {}, logs: [] },
            rework: { title: 'Rework Tasks', status: 'pending', metrics: {}, logs: [] },
            docs: { title: 'Documentation', status: 'pending', metrics: {}, logs: [] },
            art: { title: 'Artifacts', status: 'pending', metrics: {}, logs: [] },
            metrics: { title: 'Metrics Collection', status: 'pending', metrics: {}, logs: [] },
            signoff: { title: 'CEO Signoff', status: 'pending', metrics: {}, logs: [] },
            handoff: { title: 'Handoff', status: 'pending', metrics: {}, logs: [] },
            done: { title: 'Sprint Complete', status: 'pending', metrics: {}, logs: [] }
        };

        // View toggle function
        function setView(view) {
            const flowchart = document.getElementById('flowchart');
            const btnFlow = document.getElementById('btn-flow-view');
            const btnGrid = document.getElementById('btn-grid-view');

            if (view === 'flow') {
                flowchart.classList.remove('grid-view');
                flowchart.classList.add('flow-view');
                btnFlow.classList.add('active');
                btnGrid.classList.remove('active');
            } else {
                flowchart.classList.remove('flow-view');
                flowchart.classList.add('grid-view');
                btnGrid.classList.add('active');
                btnFlow.classList.remove('active');
            }

            // Save preference
            localStorage.setItem('cockpit-view', view);
        }

        // Load saved view preference
        document.addEventListener('DOMContentLoaded', function() {
            const savedView = localStorage.getItem('cockpit-view') || 'flow';
            setView(savedView);
        });
    </script>

    <!-- Cockpit JavaScript -->
    <script src="{{ url_for('static', filename='js/cockpit.js') }}?v=20260201-1"></script>
</body>
</html>
